---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(plotly)
library(shiny)
library(lubridate)

```

```{r data_import}
drug_overdose = 
  read_csv("./data/VSRR_Provisional_Drug_Overdose_Death_Counts.csv") %>% 
  janitor::clean_names()
state_level = 
  c(state.name[1:8], "District of Columbia", state.name[9:32],"New York City", state.name[33:50])

drug_overdose_52 = 
  drug_overdose %>% 
  filter(!(state_name %in% c("United States"))) %>% 
  relocate(state_name) %>% 
  mutate(month = factor(month, levels = month.name), # change month and year to factor
         year = factor(year),
         state_name = factor(state_name, levels = state_level)) %>% 
  arrange(state_name) %>% 
  select(year, state_name, indicator, deaths = predicted_value, footnote) %>% 
  filter(str_detect(indicator, "T4")) %>% 
 mutate(state= state.abb[match(state_name, state.name)],
         hover = paste0(state_name, "\nDeath:", deaths)) %>%
  filter(!is.na(deaths))

#for barplot
age_race_death = read_csv("./data/agegroup_race_state_year_99-19.csv") %>% 
  janitor::clean_names() %>% 
  select(state, year = year_code, age = ten_year_age_groups_code, race, deaths)

age_race_death_add = read_csv("./data/agegroup_race_state_year_20-21.csv") %>% 
  janitor::clean_names() %>% 
  select(state = occurrence_state, year = year_code, age = ten_year_age_groups_code, race = single_race_6, deaths) 

total_ar_death = 
  bind_rows(age_race_death, age_race_death_add) %>% 
  drop_na() %>% 
filter(!(age == "14-May"))%>%
  mutate(year = factor(year))
```

US drug overdoes death Map
===================================== 


Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# selection from
drug_choice = 
  drug_overdose_52 %>% 
  distinct(indicator) %>% 
  pull()

year = c(2015, 2018:2021)


#state select box
selectInput(
  "drug_type", 
  label = h3("Choose Indicator"),
  choices = drug_choice,
  selected = "Heroin (T40.1)")

# year select box 
selectInput("year", label = h3("Choose year"),
						choices = as.list(year),
						selected = "2018")
```

Column {.tabset}
-----------------------------------------------------------------------

### US MAP

```{r}
renderPlotly({
  font_style = list(
  size = 15, 
  color = "black"
)
label = list(
  bgcolor = "#EEEEEE",
  bordercolor = "transparent",
  font = font_style
)

graph_df = drug_overdose_52 %>% 
  filter(year == input$year) %>% 
  filter(indicator %in% input$drug_type)

plot_geo(graph_df, 
         locationmode = "USA-states") %>% 
  add_trace(locations = ~state,
            z = ~deaths,
            color = ~deaths,
            colorscale = "Blue",
            text = ~hover,
            hoverinfo = "text") %>% 
  layout(geo = list(scope = "usa"),
         title = "Death by state in the US\n2015-2021") %>% 
  style(hoverlabel = label)

})
```


Death by Age and Race
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
year = c(1999:2021)

selectInput("year2", 
            label = h3("Choose year"),
						choices = as.list(year),
						selected = 2015)
```

Column {.tabset}
-----------------------------------------------------------------------

### Dtug Overdoes Death Across All States by Age Group and Race

```{r barplot_age_race}

# plot barplot
renderPlotly({
  ar = 
    total_ar_death %>% 
  filter(year == input$year2) %>% 
	group_by(age, race) %>%
	summarize(n_deaths = sum(deaths)) %>% 
  spread(key = race, value = n_deaths) %>%
  janitor::clean_names() %>% 
  # barplot
  plot_ly(x = ~age,
  				y = ~white,
  				name = "White",
  				type = "bar") %>% 
    	add_trace(y = ~black_or_african_american,
  						name = "Black or African American") %>%
  	add_trace(y = ~asian_or_pacific_islander,
  						name = "Asian or Pacific Islander") %>% 
  	add_trace(y = ~american_indian_or_alaska_native,
  						name = "American Indian or Alaska Native") %>% 
  	layout(barmode = "stack",
  				 xaxis = list(title = "Age Groups"),
  				 yaxis = list(title = "Drug Overdoes Death")
  				 )

})


```


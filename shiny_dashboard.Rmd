---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(plotly)
```

```{r data_import}
drug_overdose = 
  read_csv("./data/VSRR_Provisional_Drug_Overdose_Death_Counts.csv") %>% 
  janitor::clean_names()
state_level = 
  c(state.name[1:8], "District of Columbia", state.name[9:32],"New York City", state.name[33:50])

drug_overdose_52 = 
  drug_overdose %>% 
  filter(!(state_name %in% c("United States"))) %>% 
  relocate(state_name) %>% 
  mutate(month = factor(month, levels = month.name), # change month and year to factor
         year = factor(year),
         state_name = factor(state_name, levels = state_level)) %>% 
  arrange(state_name) %>% 
  select(year, state_name, indicator, deaths = predicted_value, footnote) %>% 
  filter(str_detect(indicator, "T4")) %>% 
 mutate(state= state.abb[match(state_name, state.name)],
         hover = paste0(state_name, "\nDeath:", deaths)) %>%
  filter(!is.na(deaths))
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# selection from
drug_choice = 
  drug_overdose_52 %>% 
  distinct(indicator) %>% 
  pull()

year = c(2015, 2018:2021)


#state select box
selectInput(
  "drug_type", 
  label = h3("Choose Indicator"),
  choices = drug_choice,
  selected = "Heroin (T40.1)")

# year select box 
selectInput("year", label = h3("Choose year"),
						choices = as.list(year),
						selected = "2018")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
renderPlotly({
  font_style = list(
  size = 15, 
  color = "black"
)
label = list(
  bgcolor = "#EEEEEE",
  bordercolor = "transparent",
  font = font_style
)

graph_df = drug_overdose_52 %>% 
  filter(year == input$year) %>% 
  filter(indicator %in% input$drug_type)

plot_geo(graph_df, 
         locationmode = "USA-states") %>% 
  add_trace(locations = ~state,
            z = ~deaths,
            color = ~deaths,
            colorscale = "Blue",
            text = ~hover,
            hoverinfo = "text") %>% 
  layout(geo = list(scope = "usa"),
         title = "Death by state in the US\n2015-2021") %>% 
  style(hoverlabel = label)

})
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

```

### Chart C

```{r}

```

